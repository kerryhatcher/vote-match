<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }

        .info h4 {
            margin: 0 0 5px;
            color: #333;
            font-size: 16px;
        }

        .info .count {
            font-size: 18px;
            font-weight: bold;
            color: #4169E1;
            margin: 5px 0;
        }

        .legend {
            line-height: 22px;
            color: #555;
            background: white;
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            max-height: 350px;
            overflow-y: auto;
        }

        .legend h4 {
            margin: 0 0 8px;
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
            border: 1px solid #333;
        }

        .legend .circle {
            border-radius: 50%;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 5px;
        }

        .leaflet-popup-content {
            margin: 13px 19px;
            line-height: 1.4;
        }

        .popup-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .popup-section {
            margin-bottom: 8px;
        }

        .popup-label {
            font-weight: bold;
            color: #666;
        }

        .mismatch-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 6px;
            margin: 8px 0;
            border-radius: 3px;
            color: #856404;
        }

        .match-ok {
            background: #d4edda;
            border: 1px solid #28a745;
            padding: 6px;
            margin: 8px 0;
            border-radius: 3px;
            color: #155724;
        }

        .leaflet-top.leaflet-center {
            left: 50%;
            transform: translateX(-50%);
            top: 10px;
        }

        .leaflet-bottom.leaflet-center {
            left: 50%;
            transform: translateX(-50%);
            bottom: 10px;
        }

        .map-title {
            background: white;
            background: rgba(255,255,255,0.95);
            padding: 15px 30px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            font-size: 28px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }

        .map-credit {
            background: white;
            background: rgba(255,255,255,0.95);
            padding: 8px 15px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        .map-credit a {
            color: #4169E1;
            text-decoration: none;
        }

        .map-credit a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        // HTML escaping function for XSS protection
        // This uses textContent to safely escape user data before inserting into HTML
        function escapeHtml(text) {
            if (text === null || text === undefined) {
                return '';
            }
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Custom colors for voter markers (by registered district)
        const voterColors = {
            '1': '#377eb8',
            '2': '#efa710',
            '3': '#c6b0d8',
            '4': '#f2c25a',
            '5': '#e20000',
            '6': '#f96060',
            '7': '#8a664a',
            '8': '#2d802f',
            '9': '#930eb4',
        };

        // Light pastel colors for district boundaries
        const districtColors = {
            '1': '#ADD8E6',  // Light blue
            '2': '#F5DEB3',  // Light yellow/wheat
            '3': '#E6D8F0',  // Light lavender
            '4': '#FFDAB9',  // Light orange/peach
            '5': '#FFB6C1',  // Light pink
            '6': '#FFB6C1',  // Light pink (same as 5)
            '7': '#D2B48C',  // Light brown/tan
            '8': '#98FB98',  // Light green
            '9': '#DDA0DD',  // Light purple/plum
        };

        // Get color for voter markers
        function getVoterColor(district) {
            return voterColors[String(district)] || '#999999';
        }

        // Get color for district boundaries
        function getDistrictColor(district) {
            return districtColors[String(district)] || '#CCCCCC';
        }

        // Initialize map
        const map = L.map('map');

        // Create custom center positions for controls
        map._controlCorners['topcenter'] = L.DomUtil.create('div', 'leaflet-top leaflet-center', map._controlContainer);
        map._controlCorners['bottomcenter'] = L.DomUtil.create('div', 'leaflet-bottom leaflet-center', map._controlContainer);

        // Add OpenStreetMap base layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Embedded data
        const votersData = {{ voters_geojson }};
        const districtsData = {{ districts_geojson }};
        const bounds = {{ bounds }};

        // Create voter popup - all user data is escaped for XSS protection
        function createVoterPopup(properties) {
            const p = properties;
            let html = '<div class="popup-header">' + escapeHtml(p.full_name) + '</div>';

            if (p.voter_registration_number) {
                html += '<div class="popup-section">';
                html += '<span class="popup-label">Registration #:</span> ' + escapeHtml(p.voter_registration_number) + '<br>';
                html += '</div>';
            }

            html += '<div class="popup-section">';
            html += '<span class="popup-label">Address:</span> ' + escapeHtml(p.street_address) + '<br>';
            if (p.residence_city) {
                html += escapeHtml(p.residence_city) + '<br>';
            }
            html += '</div>';

            // District information
            html += '<div class="popup-section">';
            html += '<span class="popup-label">Registered District:</span> ' + escapeHtml(p.county_commission_district || 'Unknown') + '<br>';
            html += '<span class="popup-label">Spatial District:</span> ' + escapeHtml(p.spatial_district_id || 'Unknown') + '<br>';
            html += '</div>';

            // Mismatch warning
            if (p.district_mismatch) {
                html += '<div class="mismatch-warning">';
                html += '⚠️ <strong>District Mismatch!</strong><br>';
                html += 'Voter is registered in District ' + escapeHtml(p.county_commission_district);
                html += ' but located in District ' + escapeHtml(p.spatial_district_id);
                html += '</div>';
            } else if (p.spatial_district_id && p.county_commission_district) {
                html += '<div class="match-ok">';
                html += '✓ Districts match';
                html += '</div>';
            }

            // Geocoding information
            if (p.geocode_status) {
                html += '<div class="popup-section">';
                html += '<span class="popup-label">Geocode Status:</span> ' + escapeHtml(p.geocode_status) + '<br>';
                if (p.geocode_match_type) {
                    html += '<span class="popup-label">Match Type:</span> ' + escapeHtml(p.geocode_match_type) + '<br>';
                }
                html += '</div>';
            }

            return html;
        }

        // Create district popup - all user data is escaped for XSS protection
        function createDistrictPopup(properties) {
            const p = properties;
            let html = '<div class="popup-header">District ' + escapeHtml(p.district_id) + '</div>';

            if (p.district_name) {
                html += '<div class="popup-section">';
                html += escapeHtml(p.district_name) + '<br>';
                html += '</div>';
            }

            if (p.voter_count !== null && p.voter_count !== undefined) {
                html += '<div class="popup-section">';
                html += '<span class="popup-label">Voters in District:</span> ' + escapeHtml(p.voter_count) + '<br>';
                html += '</div>';
            }

            return html;
        }

        // Add district layer
        let districtLayer = null;
        if (districtsData && districtsData.features && districtsData.features.length > 0) {
            districtLayer = L.geoJSON(districtsData, {
                style: function(feature) {
                    const districtId = feature.properties.district_id;
                    return {
                        fillColor: getDistrictColor(districtId),
                        weight: 2,
                        opacity: 1,
                        color: '#333',
                        fillOpacity: 0.5
                    };
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createDistrictPopup(feature.properties));
                }
            }).addTo(map);
        }

        // Add voter layer
        let voterLayer = null;
        if (votersData && votersData.features && votersData.features.length > 0) {
            voterLayer = L.geoJSON(votersData, {
                pointToLayer: function(feature, latlng) {
                    const district = feature.properties.county_commission_district;
                    return L.circleMarker(latlng, {
                        radius: 12,
                        fillColor: getVoterColor(district),
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.7
                    });
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(createVoterPopup(feature.properties));
                }
            }).addTo(map);
        }

        // Fit map to bounds
        if (bounds && bounds.length === 2) {
            map.fitBounds(bounds, { padding: [20, 20] });
        } else {
            // Default view if no bounds
            map.setView([0, 0], 2);
        }

        // Add layer controls
        const overlayMaps = {};
        if (voterLayer) {
            overlayMaps["Voters"] = voterLayer;
        }
        if (districtLayer) {
            overlayMaps["Districts"] = districtLayer;
        }
        if (Object.keys(overlayMaps).length > 0) {
            L.control.layers(null, overlayMaps).addTo(map);
        }

        // Add info control
        const info = L.control({ position: 'topright' });
        info.onAdd = function(map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };
        info.update = function() {
            const voterCount = votersData && votersData.features ? votersData.features.length : 0;
            const districtCount = districtsData && districtsData.features ? districtsData.features.length : 0;

            let html = '<h4>{{ title }}</h4>';
            html += '<div class="count">' + voterCount.toLocaleString() + ' Voters</div>';
            if (districtCount > 0) {
                html += '<div>' + districtCount + ' Districts</div>';
            }
            this._div.innerHTML = html;
        };
        info.addTo(map);

        // Add title control
        const titleControl = L.control({ position: 'topcenter' });
        titleControl.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'map-title');
            div.textContent = '{{ title }}';
            return div;
        };
        titleControl.addTo(map);

        // Add credit control
        const creditControl = L.control({ position: 'bottomcenter' });
        creditControl.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'map-credit');
            div.textContent = 'Created by ';
            const link = document.createElement('a');
            link.href = 'https://www.kerryhatcher.com';
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.textContent = 'Kerry Hatcher';
            div.appendChild(link);
            return div;
        };
        creditControl.addTo(map);

        // Add district legend
        if (districtsData && districtsData.features && districtsData.features.length > 0) {
            const districtLegend = L.control({ position: 'bottomright' });
            districtLegend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = '<h4>District Colors</h4>';

                // Get unique districts
                const districts = [];
                for (let i = 1; i <= 9; i++) {
                    const districtId = String(i);
                    const hasDistrict = districtsData.features.some(f => String(f.properties.district_id) === districtId);
                    if (hasDistrict) {
                        districts.push(districtId);
                    }
                }

                districts.forEach(function(district) {
                    div.innerHTML +=
                        '<i style="background:' + getDistrictColor(district) + '"></i> ' +
                        'District ' + escapeHtml(district) + '<br>';
                });

                return div;
            };
            districtLegend.addTo(map);
        }

        // Add voter legend
        if (votersData && votersData.features && votersData.features.length > 0) {
            const voterLegend = L.control({ position: 'bottomleft' });
            voterLegend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = '<h4>Voter Colors<br>(by Registered District)</h4>';

                // Get unique registered districts from voters
                const registeredDistricts = new Set();
                votersData.features.forEach(function(feature) {
                    const district = feature.properties.county_commission_district;
                    if (district) {
                        registeredDistricts.add(String(district));
                    }
                });

                // Sort districts
                const sortedDistricts = Array.from(registeredDistricts).sort((a, b) => parseInt(a) - parseInt(b));

                sortedDistricts.forEach(function(district) {
                    div.innerHTML +=
                        '<i class="circle" style="background:' + getVoterColor(district) + '"></i> ' +
                        'District ' + escapeHtml(district) + '<br>';
                });

                return div;
            };
            voterLegend.addTo(map);
        }
    </script>
</body>
</html>
